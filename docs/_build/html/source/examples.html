<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN"
  "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">


<html xmlns="http://www.w3.org/1999/xhtml">
  <head>
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
    
    <title>Macau Tutorial &mdash; Macau 0.5.1 documentation</title>
    
    <link rel="stylesheet" href="../_static/classic.css" type="text/css" />
    <link rel="stylesheet" href="../_static/pygments.css" type="text/css" />
    
    <script type="text/javascript">
      var DOCUMENTATION_OPTIONS = {
        URL_ROOT:    '../',
        VERSION:     '0.5.1',
        COLLAPSE_INDEX: false,
        FILE_SUFFIX: '.html',
        HAS_SOURCE:  true
      };
    </script>
    <script type="text/javascript" src="../_static/jquery.js"></script>
    <script type="text/javascript" src="../_static/underscore.js"></script>
    <script type="text/javascript" src="../_static/doctools.js"></script>
    <script type="text/javascript" src="https://cdn.mathjax.org/mathjax/latest/MathJax.js?config=TeX-AMS-MML_HTMLorMML"></script>
    <link rel="top" title="Macau 0.5.1 documentation" href="../index.html" />
    <link rel="next" title="Saving models" href="saving_models.html" />
    <link rel="prev" title="Welcome to Macau’s documentation!" href="../index.html" /> 
  </head>
  <body role="document">
    <div class="related" role="navigation" aria-label="related navigation">
      <h3>Navigation</h3>
      <ul>
        <li class="right" style="margin-right: 10px">
          <a href="../genindex.html" title="General Index"
             accesskey="I">index</a></li>
        <li class="right" >
          <a href="saving_models.html" title="Saving models"
             accesskey="N">next</a> |</li>
        <li class="right" >
          <a href="../index.html" title="Welcome to Macau’s documentation!"
             accesskey="P">previous</a> |</li>
        <li class="nav-item nav-item-0"><a href="../index.html">Macau 0.5.1 documentation</a> &raquo;</li> 
      </ul>
    </div>  

    <div class="document">
      <div class="documentwrapper">
        <div class="bodywrapper">
          <div class="body" role="main">
            
  <div class="section" id="macau-tutorial">
<h1>Macau Tutorial<a class="headerlink" href="#macau-tutorial" title="Permalink to this headline">¶</a></h1>
<p>In these examples we use ChEMBL dataset for compound-proteins activities (IC50). The IC50 values and ECFP fingerprints can be downloaded from these two urls:</p>
<div class="highlight-bash"><div class="highlight"><pre><span></span>wget http://homes.esat.kuleuven.be/~jsimm/chembl-IC50-346targets.mm
wget http://homes.esat.kuleuven.be/~jsimm/chembl-IC50-compound-feat.mm
</pre></div>
</div>
<div class="section" id="matrix-factorization-model">
<h2>Matrix Factorization Model<a class="headerlink" href="#matrix-factorization-model" title="Permalink to this headline">¶</a></h2>
<p>The matrix factorization models cell <code class="code python docutils literal"><span class="name"><span class="pre">Y</span></span><span class="punctuation"><span class="pre">[</span></span><span class="name"><span class="pre">i</span></span><span class="punctuation"><span class="pre">,</span></span><span class="name"><span class="pre">j</span></span><span class="punctuation"><span class="pre">]</span></span></code> by the inner product of the latents</p>
<div class="math">
\[Y_{ij} \sim \mathcal{N}(\mathbf{u}_i ^ \top \mathbf{v}_j + mean, \alpha^{-1})\]</div>
<p>where <span class="math">\(\mathbf{u}_i\)</span> and <span class="math">\(\mathbf{v}_j\)</span> are the latent vector for i-th row and j-th column, and <span class="math">\(\alpha\)</span> is the precision of the observation noise.
The model also uses a fixed global mean for the whole matrix.</p>
</div>
<div class="section" id="matrix-factorization-with-side-information">
<h2>Matrix Factorization with Side Information<a class="headerlink" href="#matrix-factorization-with-side-information" title="Permalink to this headline">¶</a></h2>
<p>In this example we use MCMC (Gibbs) sampling to perform factorization of the <cite>compound x protein</cite> IC50 matrix by using ECFP features as side information on the compounds.</p>
<div class="highlight-python"><div class="highlight"><pre><span></span><span class="kn">import</span> <span class="nn">macau</span>
<span class="kn">import</span> <span class="nn">scipy.io</span>

<span class="c1">## loading data</span>
<span class="n">ic50</span> <span class="o">=</span> <span class="n">scipy</span><span class="o">.</span><span class="n">io</span><span class="o">.</span><span class="n">mmread</span><span class="p">(</span><span class="s2">&quot;chembl-IC50-346targets.mm&quot;</span><span class="p">)</span>
<span class="n">ecfp</span> <span class="o">=</span> <span class="n">scipy</span><span class="o">.</span><span class="n">io</span><span class="o">.</span><span class="n">mmread</span><span class="p">(</span><span class="s2">&quot;chembl-IC50-compound-feat.mm&quot;</span><span class="p">)</span>

<span class="c1">## running factorization (Macau)</span>
<span class="n">result</span> <span class="o">=</span> <span class="n">macau</span><span class="o">.</span><span class="n">macau</span><span class="p">(</span><span class="n">Y</span> <span class="o">=</span> <span class="n">ic50</span><span class="p">,</span>
                     <span class="n">Ytest</span>      <span class="o">=</span> <span class="mf">0.2</span><span class="p">,</span>
                     <span class="n">side</span>       <span class="o">=</span> <span class="p">[</span><span class="n">ecfp</span><span class="p">,</span> <span class="bp">None</span><span class="p">],</span>
                     <span class="n">num_latent</span> <span class="o">=</span> <span class="mi">32</span><span class="p">,</span>
                     <span class="n">precision</span>  <span class="o">=</span> <span class="mf">5.0</span><span class="p">,</span>
                     <span class="n">burnin</span>     <span class="o">=</span> <span class="mi">400</span><span class="p">,</span>
                     <span class="n">nsamples</span>   <span class="o">=</span> <span class="mi">1600</span><span class="p">)</span>
</pre></div>
</div>
<p>Input matrix for <code class="code python docutils literal"><span class="name"><span class="pre">Y</span></span></code> is a sparse scipy matrix (either coo_matrix, csr_matrix or csc_matrix).</p>
<p>In this example, we have assigned 20% of the IC50 data to the test set by setting <code class="code python docutils literal"><span class="name"><span class="pre">Ytest</span></span> <span class="operator"><span class="pre">=</span></span> <span class="literal number float"><span class="pre">0.2</span></span></code>.
If you want to use a predefined test data, set <code class="code python docutils literal"><span class="name"><span class="pre">Ytest</span></span> <span class="operator"><span class="pre">=</span></span> <span class="name"><span class="pre">my_test_matrix</span></span></code>, where the matrix is a sparse matrix of the same size as <code class="code python docutils literal"><span class="name"><span class="pre">Y</span></span></code>.
Here we have used burn-in of 400 samples for the Gibbs sampler and then collected 1600 samples from the model.
This is usually sufficient. For quick runs smaller numbers can be used, like <code class="code python docutils literal"><span class="name"><span class="pre">burnin</span></span> <span class="operator"><span class="pre">=</span></span> <span class="literal number integer"><span class="pre">100</span></span><span class="punctuation"><span class="pre">,</span></span> <span class="name"><span class="pre">nsamples</span></span> <span class="operator"><span class="pre">=</span></span> <span class="literal number integer"><span class="pre">500</span></span></code>.</p>
<p>The parameter <code class="code python docutils literal"><span class="name"><span class="pre">side</span></span> <span class="operator"><span class="pre">=</span></span> <span class="punctuation"><span class="pre">[</span></span><span class="name"><span class="pre">ecfp</span></span><span class="punctuation"><span class="pre">,</span></span> <span class="name builtin pseudo"><span class="pre">None</span></span><span class="punctuation"><span class="pre">]</span></span></code> sets the side information for rows and columns, respectively.
In this example we only use side information for the compounds (rows of the matrix).</p>
<p>The <code class="code python docutils literal"><span class="name"><span class="pre">precision</span></span> <span class="operator"><span class="pre">=</span></span> <span class="literal number float"><span class="pre">5.0</span></span></code> specifies the precision of the IC50 observations, i.e., 1 / variance.</p>
<p>When the run has completed you can check the <code class="code python docutils literal"><span class="name"><span class="pre">result</span></span></code> object and its <code class="code python docutils literal"><span class="name"><span class="pre">prediction</span></span></code> field, which is a Pandas DataFrame.</p>
<div class="highlight-python"><div class="highlight"><pre><span></span><span class="gp">&gt;&gt;&gt; </span><span class="n">result</span>
<span class="go">Matrix factorization results</span>
<span class="go">Test RMSE:        0.6393</span>
<span class="go">Matrix size:      [15073 x 346]</span>
<span class="go">Number of train:  47424</span>
<span class="go">Number of test:   11856</span>
<span class="go">To see predictions on test set see &#39;.prediction&#39; field.</span>

<span class="gp">&gt;&gt;&gt; </span><span class="n">result</span><span class="o">.</span><span class="n">prediction</span>
<span class="go">        col   row    y     y_pred      y_pred_std</span>
<span class="go">0        0   2233  5.7721  5.750984    1.177526</span>
<span class="go">1        0   2354  5.0947  5.379610    0.857858</span>
<span class="gp">...</span>
</pre></div>
</div>
<div class="section" id="univariate-sampler">
<h3>Univariate sampler<a class="headerlink" href="#univariate-sampler" title="Permalink to this headline">¶</a></h3>
<p>Macau also includes an option to use a <strong>very fast</strong> univariate sampler, i.e., instead of sampling blocks of variables jointly it samples each individually.
An example:</p>
<div class="highlight-python"><div class="highlight"><pre><span></span><span class="kn">import</span> <span class="nn">macau</span>
<span class="kn">import</span> <span class="nn">scipy.io</span>

<span class="c1">## loading data</span>
<span class="n">ic50</span> <span class="o">=</span> <span class="n">scipy</span><span class="o">.</span><span class="n">io</span><span class="o">.</span><span class="n">mmread</span><span class="p">(</span><span class="s2">&quot;chembl-IC50-346targets.mm&quot;</span><span class="p">)</span>
<span class="n">ecfp</span> <span class="o">=</span> <span class="n">scipy</span><span class="o">.</span><span class="n">io</span><span class="o">.</span><span class="n">mmread</span><span class="p">(</span><span class="s2">&quot;chembl-IC50-compound-feat.mm&quot;</span><span class="p">)</span>

<span class="c1">## running factorization (Macau)</span>
<span class="n">result</span> <span class="o">=</span> <span class="n">macau</span><span class="o">.</span><span class="n">macau</span><span class="p">(</span><span class="n">Y</span> <span class="o">=</span> <span class="n">ic50</span><span class="p">,</span>
                     <span class="n">Ytest</span>      <span class="o">=</span> <span class="mf">0.2</span><span class="p">,</span>
                     <span class="n">side</span>       <span class="o">=</span> <span class="p">[</span><span class="n">ecfp</span><span class="p">,</span> <span class="bp">None</span><span class="p">],</span>
                     <span class="n">num_latent</span> <span class="o">=</span> <span class="mi">32</span><span class="p">,</span>
                     <span class="n">precision</span>  <span class="o">=</span> <span class="mf">5.0</span><span class="p">,</span>
<span class="hll">                     <span class="n">univariate</span> <span class="o">=</span> <span class="bp">True</span><span class="p">,</span>
</span>                     <span class="n">burnin</span>     <span class="o">=</span> <span class="mi">500</span><span class="p">,</span>
                     <span class="n">nsamples</span>   <span class="o">=</span> <span class="mi">3500</span><span class="p">)</span>
</pre></div>
</div>
<p>When using it we recommend using larger values for <code class="code python docutils literal"><span class="name"><span class="pre">burnin</span></span></code> and <code class="code python docutils literal"><span class="name"><span class="pre">nsamples</span></span></code>, because the univariate sampler mixes slower than the blocked sampler.</p>
</div>
<div class="section" id="adaptive-noise">
<h3>Adaptive noise<a class="headerlink" href="#adaptive-noise" title="Permalink to this headline">¶</a></h3>
<p>In the previous examples we fixed the observation noise by specifying <code class="code python docutils literal"><span class="name"><span class="pre">precision</span></span> <span class="operator"><span class="pre">=</span></span> <span class="literal number float"><span class="pre">5.0</span></span></code>.
Instead we can also allow the model to automatically determine the precision of the noise by setting <code class="code python docutils literal"><span class="name"><span class="pre">precision</span></span> <span class="operator"><span class="pre">=</span></span> <span class="literal string double"><span class="pre">&quot;adaptive&quot;</span></span></code>.</p>
<div class="highlight-python"><div class="highlight"><pre><span></span><span class="kn">import</span> <span class="nn">macau</span>
<span class="kn">import</span> <span class="nn">scipy.io</span>

<span class="c1">## loading data</span>
<span class="n">ic50</span> <span class="o">=</span> <span class="n">scipy</span><span class="o">.</span><span class="n">io</span><span class="o">.</span><span class="n">mmread</span><span class="p">(</span><span class="s2">&quot;chembl-IC50-346targets.mm&quot;</span><span class="p">)</span>
<span class="n">ecfp</span> <span class="o">=</span> <span class="n">scipy</span><span class="o">.</span><span class="n">io</span><span class="o">.</span><span class="n">mmread</span><span class="p">(</span><span class="s2">&quot;chembl-IC50-compound-feat.mm&quot;</span><span class="p">)</span>

<span class="c1">## running factorization (Macau)</span>
<span class="n">result</span> <span class="o">=</span> <span class="n">macau</span><span class="o">.</span><span class="n">macau</span><span class="p">(</span><span class="n">Y</span> <span class="o">=</span> <span class="n">ic50</span><span class="p">,</span>
                     <span class="n">Ytest</span>      <span class="o">=</span> <span class="mf">0.2</span><span class="p">,</span>
                     <span class="n">side</span>       <span class="o">=</span> <span class="p">[</span><span class="n">ecfp</span><span class="p">,</span> <span class="bp">None</span><span class="p">],</span>
                     <span class="n">num_latent</span> <span class="o">=</span> <span class="mi">32</span><span class="p">,</span>
<span class="hll">                     <span class="n">precision</span>  <span class="o">=</span> <span class="s2">&quot;adaptive&quot;</span><span class="p">,</span>
</span>                     <span class="n">univariate</span> <span class="o">=</span> <span class="bp">True</span><span class="p">,</span>
                     <span class="n">burnin</span>     <span class="o">=</span> <span class="mi">500</span><span class="p">,</span>
                     <span class="n">nsamples</span>   <span class="o">=</span> <span class="mi">3500</span><span class="p">)</span>
</pre></div>
</div>
<p>In the case of adaptive noise the model updates (samples) the precision parameter in every iteration, which is then also shown in the output.
Additionally, there is a parameter <code class="code python docutils literal"><span class="name"><span class="pre">sn_max</span></span></code> that sets the maximum allowed signal-to-noise ratio.
This means that if the updated precision would imply a higher signal-to-noise ratio than <code class="code python docutils literal"><span class="name"><span class="pre">sn_max</span></span></code>, then the precision value is set to <code class="code python docutils literal"><span class="punctuation"><span class="pre">(</span></span><span class="name"><span class="pre">sn_max</span></span> <span class="operator"><span class="pre">+</span></span> <span class="literal number float"><span class="pre">1.0</span></span><span class="punctuation"><span class="pre">)</span></span> <span class="operator"><span class="pre">/</span></span> <span class="name"><span class="pre">Yvar</span></span></code> where Yvar is the variance of the training dataset <code class="code python docutils literal"><span class="name"><span class="pre">Y</span></span></code>.</p>
</div>
<div class="section" id="binary-matrices">
<h3>Binary matrices<a class="headerlink" href="#binary-matrices" title="Permalink to this headline">¶</a></h3>
<p>Macau can also factorize binary matrices (with or without side information). As an input the sparse matrix should only contain values of 0 or 1.
To factorize them we employ probit noise model that can be enabled by <code class="code python docutils literal"><span class="name"><span class="pre">precision</span></span> <span class="operator"><span class="pre">=</span></span> <span class="literal string double"><span class="pre">&quot;probit&quot;</span></span></code>.</p>
<p>Care has to be taken to make input to the model, as operating with sparse matrices can drop real 0 measurements. In the below example, we first copy the matrix (line 9) and then threshold the data to binary (line 10).</p>
<p>Currently, the probit model only works with the multivariate sampler (<code class="code python docutils literal"><span class="name"><span class="pre">univariate</span></span> <span class="operator"><span class="pre">=</span></span> <span class="name builtin pseudo"><span class="pre">False</span></span></code>).</p>
<div class="highlight-python"><div class="highlight"><pre><span></span><span class="kn">import</span> <span class="nn">macau</span>
<span class="kn">import</span> <span class="nn">scipy.io</span>

<span class="c1">## loading data</span>
<span class="n">ic50</span> <span class="o">=</span> <span class="n">scipy</span><span class="o">.</span><span class="n">io</span><span class="o">.</span><span class="n">mmread</span><span class="p">(</span><span class="s2">&quot;chembl-IC50-346targets.mm&quot;</span><span class="p">)</span>
<span class="n">ecfp</span> <span class="o">=</span> <span class="n">scipy</span><span class="o">.</span><span class="n">io</span><span class="o">.</span><span class="n">mmread</span><span class="p">(</span><span class="s2">&quot;chembl-IC50-compound-feat.mm&quot;</span><span class="p">)</span>

<span class="c1">## using activity threshold pIC50 &gt; 6.5</span>
<span class="hll"><span class="n">act</span> <span class="o">=</span> <span class="n">ic50</span>
</span><span class="hll"><span class="n">act</span><span class="o">.</span><span class="n">data</span> <span class="o">=</span> <span class="n">act</span><span class="o">.</span><span class="n">data</span> <span class="o">&gt;</span> <span class="mf">6.5</span>
</span>
<span class="c1">## running factorization (Macau)</span>
<span class="n">result</span> <span class="o">=</span> <span class="n">macau</span><span class="o">.</span><span class="n">macau</span><span class="p">(</span><span class="n">Y</span> <span class="o">=</span> <span class="n">act</span><span class="p">,</span>
                     <span class="n">Ytest</span>      <span class="o">=</span> <span class="mf">0.2</span><span class="p">,</span>
                     <span class="n">side</span>       <span class="o">=</span> <span class="p">[</span><span class="n">ecfp</span><span class="p">,</span> <span class="bp">None</span><span class="p">],</span>
                     <span class="n">num_latent</span> <span class="o">=</span> <span class="mi">32</span><span class="p">,</span>
<span class="hll">                     <span class="n">precision</span>  <span class="o">=</span> <span class="s2">&quot;probit&quot;</span><span class="p">,</span>
</span>                     <span class="n">univariate</span> <span class="o">=</span> <span class="bp">False</span><span class="p">,</span>
                     <span class="n">burnin</span>     <span class="o">=</span> <span class="mi">400</span><span class="p">,</span>
                     <span class="n">nsamples</span>   <span class="o">=</span> <span class="mi">1600</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<div class="section" id="matrix-factorization-without-side-information">
<h2>Matrix Factorization without Side Information<a class="headerlink" href="#matrix-factorization-without-side-information" title="Permalink to this headline">¶</a></h2>
<p>To run matrix factorization without side information you can just drop the <code class="code python docutils literal"><span class="name"><span class="pre">side</span></span></code> parameter.</p>
<div class="highlight-python"><div class="highlight"><pre><span></span><span class="n">result</span> <span class="o">=</span> <span class="n">macau</span><span class="o">.</span><span class="n">macau</span><span class="p">(</span><span class="n">Y</span> <span class="o">=</span> <span class="n">ic50</span><span class="p">,</span>
                     <span class="n">Ytest</span>      <span class="o">=</span> <span class="mf">0.2</span><span class="p">,</span>
                     <span class="n">num_latent</span> <span class="o">=</span> <span class="mi">32</span><span class="p">,</span>
                     <span class="n">precision</span>  <span class="o">=</span> <span class="mf">5.0</span><span class="p">,</span>
                     <span class="n">burnin</span>     <span class="o">=</span> <span class="mi">200</span><span class="p">,</span>
                     <span class="n">nsamples</span>   <span class="o">=</span> <span class="mi">800</span><span class="p">)</span>
</pre></div>
</div>
<p>Without side information Macau is equivalent to standard Bayesian Matrix Factorization (BPMF).
However, if available using side information can significantly improve the model accuracy.
In the case of IC50 data the accuracy improves from RMSE of 0.90 to close to 0.60.</p>
</div>
<div class="section" id="tensor-factorization">
<h2>Tensor Factorization<a class="headerlink" href="#tensor-factorization" title="Permalink to this headline">¶</a></h2>
<p>Macau also supports tensor factorization with and without side information on any of the modes.
Tensor can be thought as generalization of matrix to relations with more than two items.
For example 3-tensor of <code class="code python docutils literal"><span class="name"><span class="pre">drug</span></span> <span class="name"><span class="pre">x</span></span> <span class="name"><span class="pre">cell</span></span> <span class="name"><span class="pre">x</span></span> <span class="name"><span class="pre">gene</span></span></code> could express the effect of a drug on the given cell and gene.
In this case the prediction for the element <code class="code python docutils literal"><span class="name"><span class="pre">Yhat</span></span><span class="punctuation"><span class="pre">[</span></span><span class="name"><span class="pre">i</span></span><span class="punctuation"><span class="pre">,</span></span><span class="name"><span class="pre">j</span></span><span class="punctuation"><span class="pre">,</span></span><span class="name"><span class="pre">k</span></span><span class="punctuation"><span class="pre">]</span></span></code> is given by</p>
<div class="math">
\[\hat{Y}_{ijk} = \sum_{d=1}^D u^{(1)}_{d,i} u^{(2)}_{d,j} u^{(3)}_{d,k} + mean\]</div>
<p>Visually the model can be represented as follows:</p>
<div class="figure align-center" id="id1">
<a class="reference internal image-reference" href="../_images/tensor-model.png"><img alt="Tensor model" src="../_images/tensor-model.png" style="width: 502.45px; height: 361.4px;" /></a>
<p class="caption"><span class="caption-text">Tensor model predicts <code class="code python docutils literal"><span class="name"><span class="pre">Yhat</span></span><span class="punctuation"><span class="pre">[</span></span><span class="name"><span class="pre">i</span></span><span class="punctuation"><span class="pre">,</span></span><span class="name"><span class="pre">j</span></span><span class="punctuation"><span class="pre">,</span></span><span class="name"><span class="pre">k</span></span><span class="punctuation"><span class="pre">]</span></span></code> by element-wise multiplication of all latent vectors together and taking the sum (figure omits the global mean).</span></p>
</div>
<p>For tensors Macau packages uses Pandas <code class="code python docutils literal"><span class="name"><span class="pre">DataFrame</span></span></code> where each <strong>row</strong> stores the coordinate and the value of a known
cell in the tensor.
Specifically, the integer columns in the DataFrame give the coordinate of the cell and <code class="code python docutils literal"><span class="name builtin"><span class="pre">float</span></span></code> (or double) column
stores the value in the cell (the order of the columns does not matter).
The coordinates are 0-based.</p>
<p>Here is a simple toy example with factorizing a 3-tensor with side information on the first mode.</p>
<div class="highlight-python"><div class="highlight"><pre><span></span><span class="kn">import</span> <span class="nn">numpy</span> <span class="kn">as</span> <span class="nn">np</span>
<span class="kn">import</span> <span class="nn">pandas</span> <span class="kn">as</span> <span class="nn">pd</span>
<span class="kn">import</span> <span class="nn">scipy.sparse</span>
<span class="kn">import</span> <span class="nn">macau</span>
<span class="kn">import</span> <span class="nn">itertools</span>

<span class="c1">## generating toy data</span>
<span class="n">A</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">randn</span><span class="p">(</span><span class="mi">15</span><span class="p">,</span> <span class="mi">2</span><span class="p">)</span>
<span class="n">B</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">randn</span><span class="p">(</span><span class="mi">3</span><span class="p">,</span> <span class="mi">2</span><span class="p">)</span>
<span class="n">C</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">randn</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="mi">2</span><span class="p">)</span>

<span class="n">idx</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span> <span class="n">itertools</span><span class="o">.</span><span class="n">product</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="n">A</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]),</span>
                              <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="n">B</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]),</span>
                              <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="n">C</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]))</span> <span class="p">)</span>
<span class="n">df</span>  <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span> <span class="n">np</span><span class="o">.</span><span class="n">asarray</span><span class="p">(</span><span class="n">idx</span><span class="p">),</span> <span class="n">columns</span><span class="o">=</span><span class="p">[</span><span class="s2">&quot;A&quot;</span><span class="p">,</span> <span class="s2">&quot;B&quot;</span><span class="p">,</span> <span class="s2">&quot;C&quot;</span><span class="p">])</span>
<span class="n">df</span><span class="p">[</span><span class="s2">&quot;value&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">A</span><span class="p">[</span><span class="n">i</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="p">:]</span> <span class="o">*</span> <span class="n">B</span><span class="p">[</span><span class="n">i</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="p">:]</span> <span class="o">*</span> <span class="n">C</span><span class="p">[</span><span class="n">i</span><span class="p">[</span><span class="mi">2</span><span class="p">],</span> <span class="p">:])</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">idx</span> <span class="p">])</span>

<span class="c1">## side information is again a sparse matrix</span>
<span class="n">Acoo</span> <span class="o">=</span> <span class="n">scipy</span><span class="o">.</span><span class="n">sparse</span><span class="o">.</span><span class="n">coo_matrix</span><span class="p">(</span><span class="n">A</span><span class="p">)</span>

<span class="c1">## assigning 20% of the cells to test set</span>
<span class="n">Ytrain</span><span class="p">,</span> <span class="n">Ytest</span> <span class="o">=</span> <span class="n">macau</span><span class="o">.</span><span class="n">make_train_test_df</span><span class="p">(</span><span class="n">df</span><span class="p">,</span> <span class="mf">0.2</span><span class="p">)</span>

<span class="c1">## for artificial dataset using small values for burnin, nsamples and num_latents is fine</span>
<span class="n">results</span> <span class="o">=</span> <span class="n">macau</span><span class="o">.</span><span class="n">macau</span><span class="p">(</span><span class="n">Y</span> <span class="o">=</span> <span class="n">Ytrain</span><span class="p">,</span> <span class="n">Ytest</span> <span class="o">=</span> <span class="n">Ytest</span><span class="p">,</span> <span class="n">side</span><span class="o">=</span><span class="p">[</span><span class="n">Acoo</span><span class="p">,</span> <span class="bp">None</span><span class="p">,</span> <span class="bp">None</span><span class="p">],</span> <span class="n">num_latent</span> <span class="o">=</span> <span class="mi">4</span><span class="p">,</span>
                      <span class="n">verbose</span> <span class="o">=</span> <span class="bp">True</span><span class="p">,</span> <span class="n">burnin</span> <span class="o">=</span> <span class="mi">20</span><span class="p">,</span> <span class="n">nsamples</span> <span class="o">=</span> <span class="mi">20</span><span class="p">,</span>
                      <span class="n">univariate</span> <span class="o">=</span> <span class="bp">False</span><span class="p">,</span> <span class="n">precision</span> <span class="o">=</span> <span class="mi">50</span><span class="p">)</span>
</pre></div>
</div>
<p>The side informatoin added here is very informative, thus, using it will significantly increase
the accuracy. The factorization can be executed also without the side information by removing
<code class="code python docutils literal"><span class="name"><span class="pre">side</span></span><span class="operator"><span class="pre">=</span></span><span class="punctuation"><span class="pre">[</span></span><span class="name"><span class="pre">Acoo</span></span><span class="punctuation"><span class="pre">,</span></span> <span class="name builtin pseudo"><span class="pre">None</span></span><span class="punctuation"><span class="pre">,</span></span> <span class="name builtin pseudo"><span class="pre">None</span></span><span class="punctuation"><span class="pre">]</span></span></code>:</p>
<div class="highlight-python"><div class="highlight"><pre><span></span><span class="c1">## tensor factorization without side information</span>
<span class="n">results</span> <span class="o">=</span> <span class="n">macau</span><span class="o">.</span><span class="n">macau</span><span class="p">(</span><span class="n">Y</span> <span class="o">=</span> <span class="n">Ytrain</span><span class="p">,</span> <span class="n">Ytest</span> <span class="o">=</span> <span class="n">Ytest</span><span class="p">,</span> <span class="n">num_latent</span> <span class="o">=</span> <span class="mi">4</span><span class="p">,</span>
                      <span class="n">verbose</span> <span class="o">=</span> <span class="bp">True</span><span class="p">,</span> <span class="n">burnin</span> <span class="o">=</span> <span class="mi">20</span><span class="p">,</span> <span class="n">nsamples</span> <span class="o">=</span> <span class="mi">20</span><span class="p">,</span>
                      <span class="n">univariate</span> <span class="o">=</span> <span class="bp">False</span><span class="p">,</span> <span class="n">precision</span> <span class="o">=</span> <span class="mi">50</span><span class="p">)</span>
</pre></div>
</div>
<p>Tensor factorization also supports the univariate sampler. To execute that set <code class="code python docutils literal"><span class="name"><span class="pre">univariate</span></span> <span class="operator"><span class="pre">=</span></span> <span class="name builtin pseudo"><span class="pre">True</span></span></code>, for example</p>
<div class="highlight-python"><div class="highlight"><pre><span></span><span class="n">results</span> <span class="o">=</span> <span class="n">macau</span><span class="o">.</span><span class="n">macau</span><span class="p">(</span><span class="n">Y</span> <span class="o">=</span> <span class="n">Ytrain</span><span class="p">,</span> <span class="n">Ytest</span> <span class="o">=</span> <span class="n">Ytest</span><span class="p">,</span> <span class="n">side</span><span class="o">=</span><span class="p">[</span><span class="n">Acoo</span><span class="p">,</span> <span class="bp">None</span><span class="p">,</span> <span class="bp">None</span><span class="p">],</span> <span class="n">num_latent</span> <span class="o">=</span> <span class="mi">4</span><span class="p">,</span>
                      <span class="n">verbose</span> <span class="o">=</span> <span class="bp">True</span><span class="p">,</span> <span class="n">burnin</span> <span class="o">=</span> <span class="mi">20</span><span class="p">,</span> <span class="n">nsamples</span> <span class="o">=</span> <span class="mi">20</span><span class="p">,</span>
                      <span class="n">univariate</span> <span class="o">=</span> <span class="bp">True</span><span class="p">,</span> <span class="n">precision</span> <span class="o">=</span> <span class="mi">50</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>


          </div>
        </div>
      </div>
      <div class="sphinxsidebar" role="navigation" aria-label="main navigation">
        <div class="sphinxsidebarwrapper">
  <h3><a href="../index.html">Table Of Contents</a></h3>
  <ul>
<li><a class="reference internal" href="#">Macau Tutorial</a><ul>
<li><a class="reference internal" href="#matrix-factorization-model">Matrix Factorization Model</a></li>
<li><a class="reference internal" href="#matrix-factorization-with-side-information">Matrix Factorization with Side Information</a><ul>
<li><a class="reference internal" href="#univariate-sampler">Univariate sampler</a></li>
<li><a class="reference internal" href="#adaptive-noise">Adaptive noise</a></li>
<li><a class="reference internal" href="#binary-matrices">Binary matrices</a></li>
</ul>
</li>
<li><a class="reference internal" href="#matrix-factorization-without-side-information">Matrix Factorization without Side Information</a></li>
<li><a class="reference internal" href="#tensor-factorization">Tensor Factorization</a></li>
</ul>
</li>
</ul>

  <h4>Previous topic</h4>
  <p class="topless"><a href="../index.html"
                        title="previous chapter">Welcome to Macau&#8217;s documentation!</a></p>
  <h4>Next topic</h4>
  <p class="topless"><a href="saving_models.html"
                        title="next chapter">Saving models</a></p>
  <div role="note" aria-label="source link">
    <h3>This Page</h3>
    <ul class="this-page-menu">
      <li><a href="../_sources/source/examples.txt"
            rel="nofollow">Show Source</a></li>
    </ul>
   </div>
<div id="searchbox" style="display: none" role="search">
  <h3>Quick search</h3>
    <form class="search" action="../search.html" method="get">
      <input type="text" name="q" />
      <input type="submit" value="Go" />
      <input type="hidden" name="check_keywords" value="yes" />
      <input type="hidden" name="area" value="default" />
    </form>
    <p class="searchtip" style="font-size: 90%">
    Enter search terms or a module, class or function name.
    </p>
</div>
<script type="text/javascript">$('#searchbox').show(0);</script>
        </div>
      </div>
      <div class="clearer"></div>
    </div>
    <div class="related" role="navigation" aria-label="related navigation">
      <h3>Navigation</h3>
      <ul>
        <li class="right" style="margin-right: 10px">
          <a href="../genindex.html" title="General Index"
             >index</a></li>
        <li class="right" >
          <a href="saving_models.html" title="Saving models"
             >next</a> |</li>
        <li class="right" >
          <a href="../index.html" title="Welcome to Macau’s documentation!"
             >previous</a> |</li>
        <li class="nav-item nav-item-0"><a href="../index.html">Macau 0.5.1 documentation</a> &raquo;</li> 
      </ul>
    </div>
    <div class="footer" role="contentinfo">
        &copy; Copyright 2016-2017, Jaak Simm.
      Created using <a href="http://sphinx-doc.org/">Sphinx</a> 1.3.6.
    </div>
  </body>
</html>